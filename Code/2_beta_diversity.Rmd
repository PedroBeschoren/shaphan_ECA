---
title: "2_beta_diversity"
author: "shaphan"
date: "11/17/2022"
output: html_document
editor_options: 
  
  
  chunk_output_type: console
---


# 0 - Load libraries & data


```{r}


#load necessary libraries
library(phyloseq)
library(ggplot2)
library(vegan)
library(EcolUtils)
library(microbiome)
library(car)
library(agricolae)
library(metagMisc)
library("ggpubr")
library(purrr)
library(EcolUtils)


# increases memory limit used by R
memory.limit(size = 350000)



#load the phyloseq objects containing all microbiome data
load(file = "./Data/CSS_BacFun_ps_l.RData")





```


#separate bulk soil from rhizosphere and frass
```{r}

CSS_bac_ps_sampletype_l<-metagMisc::phyloseq_sep_variable(CSS_BacFun_ps_l$Bac, variable = "sample_type")
CSS_fun_ps_sampletype_l<-metagMisc::phyloseq_sep_variable(CSS_BacFun_ps_l$Fun, variable = "sample_type")



```


# 1 - Check beta diversity in a NMDS ordination

Some clustering and treatment effects are evident!
```{r}


NMDS_Bac_l <-lapply(CSS_bac_ps_sampletype_l, function (x)
          ordinate(x,
                   method="NMDS",
                   distance="bray",
                   try=2000,
                   autotransform=TRUE))




# define a function to calculate and plot NMDS based on bray-curtis
NMDS_calculation_l <- function(physeq_l, ordination_output) {
  
  # this function takes as input a list of phyloseq objects and a list of calculated ordinations
  # it also takes a list of bray-curtis distances calculated with phyloseq::ordinate
  # it returns a list of NMDS plots, with titles in each plot
  
  untitled_plot_l<-mapply(function(x, y)
    phyloseq::plot_ordination(physeq = x, 
                              ordination = y,
                              color ="frass_source",
                              shape = "frass_treatment_and_dose")+
      scale_shape_manual(values=c(1,2,16, 17,7,8))+
      theme_classic() +
      labs(subtitle = paste("Stress", round(y$stress, digits=4))) +
      theme(plot.title = element_text(size = 10, face = "bold")) +
      theme(legend.position="right"),
    x = physeq_l,
    y = ordination_output,
    SIMPLIFY = FALSE)
  
  
  
  
  titles_l <- names(physeq_l)
  
  
  
  Plot_l<- mapply(function (z,w)
    z + ggtitle(w),
    z = untitled_plot_l,
    w = titles_l,
    SIMPLIFY = FALSE)
  
  return(Plot_l)
}

#use custom function, creating a list of plotsfunction
NMDS_plots_l<-NMDS_calculation_l(CSS_bac_ps_sampletype_l, NMDS_Bac_l )
NMDS_plots_l
# arrange all 3 plots in a pannel
NMDS_plots_l<-ggarrange(NMDS_plots_l$bulk_soil,
                        NMDS_plots_l$rhizosphere,
                        NMDS_plots_l$frass)


#export plot
ggsave(filename = "./Results/NMDS_3_sample_types.pdf" ,
       plot = NMDS_plots_l,
       width = 30,
       height =30,
       units = "cm" )



```


#filter samples and recalcuate ordintions

```{r}
# remove frass sample type from list
CSS_bac_ps_filt_l<-CSS_bac_ps_sampletype_l[c(1,3)]

# remove frass source N from samples
CSS_bac_ps_filt_l<-lapply(CSS_bac_ps_filt_l, function(x){
  x<-subset_samples(x, frass_source != "N") # from frass source N
  x<-prune_taxa(taxa_sums(otu_table(x)) > 0, x) # remove ASVs with zero counts (that is, ASVS that only show up on frass source N)
return(x)
})




NMDS_Bac_filt_l <-lapply(CSS_bac_ps_filt_l, function (x)
          ordinate(x,
                   method="NMDS",
                   distance="bray",
                   try=2000,
                   autotransform=TRUE))


#use custom function, creating a list of plotsfunction
NMDS_plots_filt_l<-NMDS_calculation_l(CSS_bac_ps_filt_l, NMDS_Bac_filt_l )
NMDS_plots_filt_l

# arrange all 3 plots in a pannel
NMDS_plots_filt_l<-ggarrange(NMDS_plots_filt_l$bulk_soil,
                            NMDS_plots_filt_l$rhizosphere)



#export plot
ggsave(filename = "./Results/NMDS_RhizoBulk_types.pdf" ,
       plot = NMDS_plots_filt_l,
       width = 20,
       height = 20,
       units = "cm" )

```




# 2 - check beta dispersion

beta dispersion is like multivatite homogeniety of variances. just like you can't compare properly very small error bars with very large error bars, you should check if the spread of the data clouds is similar per treatment


```{r}

#define function to calculate and plot beta dispersion
beta_disp_plotAndTest<-function(phyloseq_list, group){
  # phyloseq_list = a list of phyloseq objects
  # group = the variable you want to test the beta dispersion of, in quotes
    beta_disper_list<-lapply(phyloseq_list, function (x) 
  betadisper(phyloseq::distance(t(otu_table(x)), method="bray"), sample_data(x)[[group]])) #selects only column "group""

  # gets the names of the list
tiles_list<-names(beta_disper_list)
  
  #runs anova on beta dispersions
get_p<-lapply(beta_disper_list, function (x) 
  anova(x, permutations = 999))


p_dispersion<-map(get_p, 5) # gets the p value of the dispersion test
p_dispersion <- p_dispersion[!is.na(p_dispersion)] # removes the generated NA


#runs anova on beta dispersions
bet_disp_PCOa_plot<-mapply(function (x,y,z) 
  plot(x, 
       main = y, 
       sub =z, 
       xlab="p value for homogeniety test:", 
       ylab="PCoA"),
  x = beta_disper_list,
  y = tiles_list,
  z = p_dispersion,
  SIMPLIFY = FALSE) 

#runs anova on beta dispersions
bet_disp_boxplot<-mapply(function (x,y) 
  boxplot(x, main = y),
  x = beta_disper_list,
  y = tiles_list,
  SIMPLIFY = FALSE)


return(list(bet_disp_PCOa_plot,bet_disp_boxplot))
}


# execute custom fucntion above
beta_disp_plotAndTest(CSS_bac_ps_filt_l, "frass_source")
beta_disp_plotAndTest(CSS_bac_ps_filt_l, "frass_dose")
beta_disp_plotAndTest(CSS_bac_ps_filt_l, "frass_treatment")
beta_disp_plotAndTest(CSS_bac_ps_filt_l, "frass_treatment_and_dose")





```

# 3 - run PERMANOVA and post-hoc test

We see significant treatment effects, with clear pairwise distinctions



```{r}
#testing permanovas 16S
set.seed(303848)
permanova_Bac_results <- lapply(CSS_bac_ps_filt_l, function (x)
       adonis2(formula = phyloseq::distance(t(otu_table(x)), method="bray") ~ frass_treatment*frass_source*frass_dose,
              data = as(sample_data(x),"data.frame"), # changing with as.data.frame is insufficient
              permutations = how(nperm=999)))




# Pairwise PERMANOVA 16S Stress factor

set.seed(303848)
pairwise_permanova_bac_results <- lapply(CSS_bac_ps_filt_l, function (x)
  adonis2(dist.mat= phyloseq::distance(otu_table(x), method="bray"),
              Factor= as.factor(as(phyloseq::sample_data(x),"data.frame")$frass_treatment)))



```


# 4 - Alpha diversity calculations & plot



```{r}


library("microbiome")
#Calculate richness for root and soil
calculated_diversity<-microbiome::diversity(rarefied_Bac_ps)


n_sequences<-sample_sums(rarefied_Bac_ps)
calculated_diversity$n_sequences<-n_sequences



#### add diversity metrics to mapping file of phyloseq objects
# we do this so we can perform anovas, acess metadat, make nicer plots, etc
merg_to_ps<-sample_data(calculated_diversity) # makes the diversity calculations  sample_data for phyloseq oject...
calculated_diversity_df<-as(sample_data(merge_phyloseq(rarefied_Bac_ps,merg_to_ps)),"data.frame") # forces sample data of updated phyloseq object into a dataframe


#Lets see this on a simple boxplot for Shannon diversity index
alpha_plot_temp<-ggplot(calculated_diversity_df, aes(x =frass_treatment, y = fisher, fill =frass_source ))+
  geom_boxplot()+
  theme_bw()+
  facet_wrap(~frass_dose + amendment + sample_type )
  labs(title = "Fisher diversity indexes")



ggsave(filename = "./Results/aplha_div.pdf",
       plot = alpha_plot_temp,
       width = 30,
       height = 30,
       units = "cm")


```


# 5 - alpha diversity tests
Shannon diversity has a bit of heterogeniety per treatent:  p= 0.051. Fisher diversity instead has p=0.90 and the pattern in teh plot is the same. stats and post-hoc of shannon and fisher are similar.  let's use fisher diversities here due to lower heterogeniety


```{r}
library("car")
# chech homogeniety of variances
leveneTest((fisher) ~ amendment, data = calculated_diversity_df)




# anova test
anova_fisher<-aov(fisher ~ amendment*frass_source*frass_treatment, data = calculated_diversity_df)



# get p values
summary(anova_fisher)



# post-hoc, both Tukey and Least Significat Difference
LSD.test(y = anova_fisher, "amendment", group=TRUE, console=TRUE)

```



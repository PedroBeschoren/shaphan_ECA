---
title: "2_beta_diversity"
author: "shaphan"
date: "11/17/2022"
output: html_document
editor_options: 
  chunk_output_type: console
  
  
---


# 0 - Load libraries & data


```{r}


#load necessary libraries
library(phyloseq)
library(ggplot2)
library(vegan)
library(EcolUtils)
library(microbiome)
library(car)
library(agricolae)



#load the phyloseq objects containing all microbiome data
load(file = "./Data/CSS_Bac_ps.RData")
load(file = "./Data/rarefied_bac_ps.RData")


CSS_bac_ps
rarefied_Bac_ps

# samples present in both dataset
which(sample_names(CSS_bac_ps) %in% sample_names(rarefied_Bac_ps))
diff_sample<-which(!sample_names(CSS_bac_ps) %in% sample_names(rarefied_Bac_ps))

```


#separate bulk soil from rhizosphere and frass
```{r}
CSS_bac_ps@sam_data


CSS_bac_ps_rhizosphere<-subset_samples(CSS_bac_ps, sample_type  =="rhizosphere")
CSS_bac_ps_rhizosphere<-prune_taxa(taxa = rowSums(otu_table(CSS_bac_ps_rhizosphere))>0,
                                  x = CSS_bac_ps_rhizosphere)

CSS_bac_ps_bulk<-subset_samples(CSS_bac_ps, sample_type  =="bulk_soil")
CSS_bac_ps_bulk<-prune_taxa(taxa = rowSums(otu_table(CSS_bac_ps_bulk))>0,
                                  x = CSS_bac_ps_bulk)

CSS_bac_ps_frass<-subset_samples(CSS_bac_ps, sample_type  =="frass")
CSS_bac_ps_frass<-prune_taxa(taxa = rowSums(otu_table(CSS_bac_ps_frass))>0,
                                  x = CSS_bac_ps_frass)

```


# 1 - Check beta diversity in a NMDS ordination

Some clustering and treatment effects are evident!
```{r}
#create sample__name variable
CSS_bac_ps_rhizosphere@sam_data$sample__name<-sample_names(CSS_bac_ps_rhizosphere)


# remove outliers
CSS_bac_ps_rhizosphere<-subset_samples(physeq = CSS_bac_ps_rhizosphere, sample__name != "83R")
CSS_bac_ps_rhizosphere<-subset_samples(physeq = CSS_bac_ps_rhizosphere, sample__name != "5R")                                       

# Let's make a Non-Metric Multidimensional Scaling (NMDS) of all our samples based on CSS normalization
nmds   <- phyloseq::ordinate(CSS_bac_ps_rhizosphere,
                             method ="NMDS", # this method has few assumptions and readly accepts different data structures
                             distance="bray", # bray-curtis distance is suitable for sparse data - such as the zero-inflated microbiome data we have
                             try=500, # number of iterations
                             autotransform=TRUE) # automatically transforms your data, if needed. reduces weight of outliers
                              #weakties = FALSE prevests tress from colapsing into zero
#saves calculated NMDS
#save(nmds, file = "./Data/CSS_Bac_NMDS.RData")


#plot NMDS ordination
plot1<-plot_ordination(physeq = CSS_bac_ps_rhizosphere,
                ordination = nmds,
                color= "frass_treatment",
                shape = "frass_source")+
  theme_classic() +
  geom_point(aes(size=frass_dose))+
  facet_wrap(~amendment)+
  theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5)) +
  theme(legend.position="right")


#export plot
ggsave(filename = "./Results/NMDS_rhizosphere.pdf" ,
       plot = plot1,
       width = 25,
        height =15,
       units = "cm" )

```

```{r}
#create sample__name variable
CSS_bac_ps_bulk@sam_data$sample__name<-sample_names(CSS_bac_ps_bulk)




# Let's make a Non-Metric Multidimensional Scaling (NMDS) of all our samples based on CSS normalization
nmds2   <- phyloseq::ordinate(CSS_bac_ps_bulk,
                             method ="NMDS", # this method has few assumptions and readly accepts different data structures
                             distance="bray", # bray-curtis distance is suitable for sparse data - such as the zero-inflated microbiome data we have
                             try=500, # number of iterations
                             autotransform=TRUE) # automatically transforms your data, if needed. reduces weight of outliers
                              #weakties = FALSE prevests tress from colapsing into zero
#saves calculated NMDS
#save(nmds, file = "./Data/CSS_Bac_NMDS.RData")
nmds2$points

#plot NMDS ordination
plot2<-plot_ordination(physeq = CSS_bac_ps_bulk,
                ordination = nmds2,
                color= "frass_treatment",
                shape = "frass_source")+
  theme_classic() +
  geom_point(aes(size=frass_dose))+
  facet_wrap(~amendment)+
  theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5)) +
  theme(legend.position="right")


library(ggplot2)
#export plot
ggsave(filename = "./Results/NMDS_bulkSoil.pdf" ,
       plot = plot2,
       width = 25,
        height =15,
       units = "cm" )
```

```{r}
#create sample__name variable
CSS_bac_ps_frass@sam_data$sample__name<-sample_names(CSS_bac_ps_frass)


# Let's make a Non-Metric Multidimensional Scaling (NMDS) of all our samples based on CSS normalization
nmds3   <- phyloseq::ordinate(CSS_bac_ps_frass,
                             method ="NMDS", # this method has few assumptions and readly accepts different data structures
                             distance="bray", # bray-curtis distance is suitable for sparse data - such as the zero-inflated microbiome data we have
                             try=500, # number of iterations
                             autotransform=TRUE) # automatically transforms your data, if needed. reduces weight of outliers
                              #weakties = FALSE prevests tress from colapsing into zero
#saves calculated NMDS
#save(nmds, file = "./Data/CSS_Bac_NMDS.RData")
nmds3$points

#plot NMDS ordination
plot3<-plot_ordination(physeq = CSS_bac_ps_frass,
                ordination = nmds3,
                color= "frass_treatment",
                shape = "frass_source")+
  theme_classic() +
  geom_point(aes())+
  theme(plot.title = element_text(size = 10, face = "bold", hjust = 0.5)) +
  theme(legend.position="right")


#export plot
ggsave(filename = "./Results/NMDS_frass.pdf" ,
       plot = plot3,
       width = 25,
        height =15,
       units = "cm" )



```


# 2 - check beta dispersion

beta dispersion is like multivatite homogeniety of variances. just like you can't compare properly very small error bars with very large error bars, you should check if the spread of the data clouds is similar per treatment

# rhisophere

```{r}
#calculates beta dispersions of the treatment effects
beta_disper<- betadisper(d = phyloseq::distance(t(otu_table(CSS_bac_ps_rhizosphere)), method="bray"),
                         group = sample_data(CSS_bac_ps_rhizosphere)[["frass_dose"]])



# check if ebta dispersions are significantly differente
beta_disper_calc<-anova(beta_disper, permutations = 999)



# saves the p value of the dispersion test
p_dispersion<-beta_disper_calc[[5]][1]



#plots a spdier plot (PCoA) with centroids
plot(beta_disper,
     main = "Beta Dispersion",
     sub = p_dispersion,
     xlab="p value for homogeniety of multivariate variances:")



```

# beta dispersion, bulk_soil

```{r}
#calculates beta dispersions of the treatment effects
beta_disper<- betadisper(d = phyloseq::distance(t(otu_table(CSS_bac_ps_bulk)), 
              method="bray"),
         group = sample_data(CSS_bac_ps_bulk)[["frass_dose"]])



# check if ebta dispersions are significantly differente
beta_disper_calc<-anova(beta_disper, permutations = 999)



# saves the p value of the dispersion test
p_dispersion<-beta_disper_calc[[5]][1]



#plots a spdier plot (PCoA) with centroids
plot(beta_disper,
     main = "Beta Dispersion",
     sub = p_dispersion,
     xlab="p value for homogeniety of multivariate variances:")
```

#beta dispersion, frass

```{r}


#calculates beta dispersions of the treatment effects
beta_disper<- betadisper(d = phyloseq::distance(t(otu_table(CSS_bac_ps_frass)), method="bray"),
              group = sample_data(CSS_bac_ps_frass)[["frass_treatment"]])



# check if ebta dispersions are significantly differente
beta_disper_calc<-anova(beta_disper, permutations = 999)



# saves the p value of the dispersion test
p_dispersion<-beta_disper_calc[[5]][1]



#plots a spdier plot (PCoA) with centroids
plot(beta_disper,
     main = "Beta Dispersion",
     sub = p_dispersion,
     xlab="p value for homogeniety of multivariate variances:")


```



# 3 - run PERMANOVA and post-hoc test

We see significant treatment effects, with clear pairwise distinctions



```{r}
CSS_bac_ps_rhizosphere<-subset_samples(CSS_bac_ps_rhizosphere, frass_treatment !="N")


# Running the permanova with vegan::adonis2() on a single phyloseq object is very simple
metadata<-as(sample_data(CSS_bac_ps_rhizosphere),"data.frame")
#let's first define permutation design with permute::how()
perm2<-how(# define blocks
           nperm=999)# n of permutations



# now let's calculate the permanova
adonis2(phyloseq::distance(t(otu_table(CSS_bac_ps_rhizosphere)), method="bray") # this is your distance matrix of OTU abundances
        ~ frass_treatment*frass_source*frass_dose, # this is your model
        permutations=how(nperm=999), # we jsut defined the permutation settings above, you place them here
        data = metadata) # metadata for the community matrix



# post-hoc
adonis.pair(dist.mat= phyloseq::distance(otu_table(CSS_bac_ps), method="bray"),
 Factor= as.factor(as(phyloseq::sample_data(CSS_bac_ps),"data.frame")$amendment))


```


```{r}
CSS_bac_ps_bulk<-subset_samples(CSS_bac_ps_bulk, frass_treatment !="N")


# Running the permanova with vegan::adonis2() on a single phyloseq object is very simple
metadata<-as(sample_data(CSS_bac_ps_bulk),"data.frame")
#let's first define permutation design with permute::how()
perm2<-how(# define blocks
           nperm=999)# n of permutations



# now let's calculate the permanova
adonis2(phyloseq::distance(t(otu_table(CSS_bac_ps_bulk)), method="bray") # this is your distance matrix of OTU abundances
        ~ frass_treatment*frass_source*frass_dose, # this is your model
        permutations=how(nperm=999), # we jsut defined the permutation settings above, you place them here
        data = metadata) # metadata for the community matrix



# post-hoc
adonis.pair(dist.mat= phyloseq::distance(otu_table(CSS_bac_ps), method="bray"),
  Factor= as.factor(as(phyloseq::sample_data(CSS_bac_ps),"data.frame")$amendment))


```


```{r}


```



# 4 - Alpha diversity calculations & plot



```{r}


library("microbiome")
#Calculate richness for root and soil
calculated_diversity<-microbiome::diversity(rarefied_Bac_ps)


n_sequences<-sample_sums(rarefied_Bac_ps)
calculated_diversity$n_sequences<-n_sequences



#### add diversity metrics to mapping file of phyloseq objects
# we do this so we can perform anovas, acess metadat, make nicer plots, etc
merg_to_ps<-sample_data(calculated_diversity) # makes the diversity calculations  sample_data for phyloseq oject...
calculated_diversity_df<-as(sample_data(merge_phyloseq(rarefied_Bac_ps,merg_to_ps)),"data.frame") # forces sample data of updated phyloseq object into a dataframe


#Lets see this on a simple boxplot for Shannon diversity index
alpha_plot_temp<-ggplot(calculated_diversity_df, aes(x =frass_treatment, y = fisher, fill =frass_source ))+
  geom_boxplot()+
  theme_bw()+
  facet_wrap(~frass_dose + amendment + sample_type )
  labs(title = "Fisher diversity indexes")



ggsave(filename = "./Results/aplha_div.pdf",
       plot = alpha_plot_temp,
       width = 30,
       height = 30,
       units = "cm")


```


# 5 - alpha diversity tests
Shannon diversity has a bit of heterogeniety per treatent:  p= 0.051. Fisher diversity instead has p=0.90 and the pattern in teh plot is the same. stats and post-hoc of shannon and fisher are similar.  let's use fisher diversities here due to lower heterogeniety


```{r}
library("car")
# chech homogeniety of variances
leveneTest((fisher) ~ amendment, data = calculated_diversity_df)




# anova test
anova_fisher<-aov(fisher ~ amendment*frass_source*frass_treatment, data = calculated_diversity_df)



# get p values
summary(anova_fisher)



# post-hoc, both Tukey and Least Significat Difference
LSD.test(y = anova_fisher, "amendment", group=TRUE, console=TRUE)

```


